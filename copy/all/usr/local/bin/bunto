#!/usr/bin/env ruby

def _10?
  @_10 || begin
    Gem::Version.new(ENV["BUNTO_VERSION"].split("@") \
      .last) == Gem::Version.new("1.0")
  rescue
    false
  end
end

#

def b?
  %W(b build).include?(
    ARGV[0]
  )
end

#

def s?
  %W(s serve server).include?(
    ARGV[0]
  )
end

ARGV.shift and ARGV.unshift("serve") if "s" == ARGV[0]
ARGV.push("--future", "--unpublished", "--drafts") if (!ENV["BUNTO_ENV"] || ENV["BUNTO_ENV"] == "development") && (b? || s?) && !_10?
ARGV.push("--force_polling") if (ENV["FORCE_POLLING"] || ENV["POLLING"]) && (b? || s?)
ARGV.push("--verbose") if ENV["DEBUG"] || ENV["VERBOSE"]
ARGV.unshift(ARGV.shift, "-H", "0.0.0.0") if s?

exec "chpst", "-u", "bunto:bunto", Gem.bin_path("bunto", "bunto"), *ARGV if Process.uid == 0 || Process.euid == 0
# ^, make sure that no matter what our shim methods do not get in the way of Bunto so that we do not interfere in any way.
exec Gem.bin_path("bunto", "bunto"), *ARGV
